<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Live Journey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .badge {
      position: absolute; top: 10px; left: 10px;
      background: #fff; padding: 6px 10px; border-radius: 8px;
      font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,.15); z-index: 500;
    }
    .badge small { color: #666; }

    /* -------- Fancy markers -------- */
    .pulse {
      position: relative;
      width: 16px; height: 16px;
      background: #1976d2;
      border-radius: 50%;
      box-shadow: 0 0 0 2px #fff, 0 0 6px rgba(0,0,0,.35);
    }
    .pulse::after {
      content: "";
      position: absolute; inset: 0;
      border-radius: 50%;
      box-shadow: 0 0 0 0 rgba(25,118,210,0.35);
      animation: pulse 1.8s infinite;
    }
    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(25,118,210,0.35); }
      70%  { box-shadow: 0 0 0 16px rgba(25,118,210,0); }
      100% { box-shadow: 0 0 0 0 rgba(25,118,210,0); }
    }
    .start-pin {
      width: 18px; height: 18px; border-radius: 50%;
      background: #2e7d32; border: 2px solid #fff;
      box-shadow: 0 0 6px rgba(0,0,0,.35);
    }
    .fix-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #ff7043; border: 1px solid #fff;
      box-shadow: 0 0 2px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="badge" id="info">Loading…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // -------- CONFIG --------
    const GEOJSON_URL = "https://n8n.loopandlearnjazz.com/webhook/geojson";
    const POLL_MS = 30 * 60 * 1000; // 30 minutes
    // ------------------------

    // ---- Basemaps ----
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap contributors'
    });
    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '© OpenStreetMap, © CARTO'
    });
    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '© OpenStreetMap, © CARTO'
    });
    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: 'Tiles © Esri, Maxar, Earthstar Geographics'
    });
    const openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17, attribution: '© OpenStreetMap, © SRTM | OpenTopoMap'
    });

    // ---- Map ----
    const map = L.map('map');
    esriSat.addTo(map);
    map.setView([38.34345, -0.48406], 14); // initial visible area

    // ---- Overlays ----
    const trail = L.polyline([], { weight: 4 });
    const pulseIcon = L.divIcon({ html: '<div class="pulse"></div>', iconSize: [16,16], iconAnchor: [8,8] });
    const meMarker = L.marker([0,0], { icon: pulseIcon });
    const acc = L.circle([0,0], { radius: 0 });
    const startIcon = L.divIcon({ html: '<div class="start-pin"></div>', iconSize: [18,18], iconAnchor: [9,9] });
    const startMarker = L.marker([0,0], { icon: startIcon });
    const fixesGroup = L.layerGroup();

    const baseMaps = {
      'Esri Satellite': esriSat,
      'OpenStreetMap': osm,
      'Carto Light': cartoLight,
      'Carto Dark': cartoDark,
      'OpenTopoMap': openTopo
    };
    const overlays = {
      'Trail': trail,
      'Position': L.layerGroup([meMarker, acc]),
      'Start': startMarker,
      'Fixes': fixesGroup
    };
    L.control.layers(baseMaps, overlays, { collapsed: false, position: 'topright' }).addTo(map);
    L.control.scale({ position: 'bottomleft' }).addTo(map);

    // Default visible layers
    trail.addTo(map);
    meMarker.addTo(map);
    acc.addTo(map);
    startMarker.addTo(map);

    const info = document.getElementById('info');
    let firstFitDone = false;
    const toLatLngs = coords => coords.map(([lng,lat]) => [lat,lng]);
    const fmtTs = ts => { const n=Number(ts); return isFinite(n)?new Date(n).toLocaleString():String(ts); };

    async function fetchFC(){
      const res = await fetch(GEOJSON_URL, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      return Array.isArray(data)?data[0]:data;
    }

    function applyFC(fc){
      if(!fc || fc.type!=='FeatureCollection') throw new Error('Not a FeatureCollection');
      const features = Array.isArray(fc.features)?fc.features:[];
      const trailF = features.find(f=>f?.properties?.kind==='trail'&&f.geometry?.type==='LineString');
      const youF   = features.find(f=>f?.properties?.kind==='you'  &&f.geometry?.type==='Point');

      // Trail and start marker
      if(trailF?.geometry?.coordinates?.length>=2){
        const latlngs = toLatLngs(trailF.geometry.coordinates);
        trail.setLatLngs(latlngs);
        const [startLng,startLat] = trailF.geometry.coordinates[0];
        startMarker.setLatLng([startLat,startLng]);
        fixesGroup.clearLayers();
        trailF.geometry.coordinates.forEach(([lng,lat])=>{
          const icon = L.divIcon({ html:'<div class="fix-dot"></div>', iconSize:[8,8], iconAnchor:[4,4] });
          fixesGroup.addLayer(L.marker([lat,lng],{icon}));
        });
        if(!firstFitDone){ map.fitBounds(trail.getBounds(),{padding:[30,30]}); firstFitDone=true; }
      } else {
        trail.setLatLngs([]);
        fixesGroup.clearLayers();
      }

      // Current position
      if(youF?.geometry?.coordinates?.length===2){
        const [lng,lat]=youF.geometry.coordinates;
        meMarker.setLatLng([lat,lng]);
        acc.setLatLng([lat,lng]).setRadius(Number(youF.properties?.accuracy)||0);
        if(!firstFitDone){ map.setView([lat,lng],15); firstFitDone=true; }

        const spd=youF.properties?.speed,batt=youF.properties?.battery,ts=youF.properties?.ts,gmaps=youF.properties?.gmaps;
        const html =
          `<div style="min-width:160px">
            <div><strong>Current position</strong></div>
            <div>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}</div>
            ${spd!=null?`<div>Speed: ${Number(spd).toFixed(1)} m/s</div>`:''}
            ${batt!=null?`<div>Battery: ${batt}%</div>`:''}
            ${ts?`<div>${fmtTs(ts)}</div>`:''}
            ${gmaps?`<div style="margin-top:6px;"><a href="${gmaps}" target="_blank" rel="noopener">Open in Google Maps</a></div>`:''}
           </div>`;
        meMarker.bindPopup(html);
        info.innerHTML =
          `<strong>Last fix:</strong> ${fmtTs(ts)}<br/>` +
          (spd!=null?`<small>Speed: ${Number(spd).toFixed(1)} m/s</small><br/>`:'') +
          (batt!=null?`<small>Battery: ${batt}%</small>`:'');
      } else info.textContent='No current position';
    }

    async function refresh(){
      try{ applyFC(await fetchFC()); }
      catch(e){
        info.textContent = `Unable to load location (${e?.message || e})`;
        if(!map._loaded) map.setView([0,0],2);
      }
    }

    refresh();
    setInterval(refresh, POLL_MS);
  </script>
</body>
</html>
